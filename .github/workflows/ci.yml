name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: ${{ matrix.os }} - ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04]
        compiler:
          - name: gcc
            cc: gcc-13
            cxx: g++-13
          - name: clang
            cc: clang-17
            cxx: clang++-17

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          curl \
          zip \
          unzip \
          tar \
          pkg-config \
          clang-format \
          clang-tidy \
          libclang-dev
        
        # Install specific compilers if needed
        if [ "${{ matrix.compiler.name }}" = "gcc" ]; then
          sudo apt-get install -y gcc-13 g++-13
        elif [ "${{ matrix.compiler.name }}" = "clang" ]; then
          sudo apt-get install -y clang-17
        fi

    - name: Install Rust (for Zenoh)
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Build and Install Zenoh
      run: |
        ZENOH_VERSION=1.0.6
        curl -L https://github.com/eclipse-zenoh/zenoh-c/archive/refs/tags/${ZENOH_VERSION}.tar.gz | tar xz
        cd zenoh-c-${ZENOH_VERSION}
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Setup vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg.git ~/vcpkg
        ~/vcpkg/bootstrap-vcpkg.sh
        echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV
        echo "$HOME/vcpkg" >> $GITHUB_PATH

    - name: Cache vcpkg packages
      uses: actions/cache@v4
      with:
        path: |
          ~/vcpkg/installed
          ~/vcpkg/packages
          ~/vcpkg/buildtrees
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: Configure CMake
      env:
        CC: ${{ matrix.compiler.cc }}
        CXX: ${{ matrix.compiler.cxx }}
      run: |
        cmake --preset default

    - name: Build
      run: |
        cmake --build build/default --parallel $(nproc)

    - name: Run tests
      run: |
        cd build/default
        ctest --output-on-failure --parallel $(nproc)

    - name: Check formatting
      if: matrix.compiler.name == 'clang'
      run: |
        # Check if code is properly formatted
        find runtime tools -name "*.cpp" -o -name "*.hpp" | \
          xargs clang-format --dry-run --Werror

  format-check:
    name: Format Check
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    - name: Check code formatting
      run: |
        # Find all C++ files and check formatting
        CHANGED_FILES=$(find runtime tools -type f \( -name "*.cpp" -o -name "*.hpp" \) -exec \
          clang-format --dry-run --Werror {} + 2>&1 || true)
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "::error::Code formatting issues found. Run 'clang-format -i' on the following files:"
          echo "$CHANGED_FILES"
          exit 1
        else
          echo "All files are properly formatted."
        fi
